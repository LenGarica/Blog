# 数据仓库实战

## 一、数仓概念

![warehouse](..\picture\warehouse.png)

数据仓库用来存储企业数据，为企业制定决策，提供数据支持，改进业务流程和提高产品质量。

数据分类：业务数据、用户行为数据、爬虫数据。

业务数据：商品搜索列表、订单数据、支付数据等。其特征响应非常迅速，通常使用关系型数据库来存储。

用户行为数据：用户在页面点击事件，使用用户日志文件进行存储。

爬虫数据：爬取他人数据。

## 二、数据分层

实际情况下，我们所面临的数据状况是复杂性高、层级混乱的，我们可能会做出一套表依赖结构混乱，且出现循环依赖的数据体系。为了解决我们可能面临的问题，需要一套行之有效的数据组织、管理和处理方法，来让我们的数据体系更加有序，这就是数据分层。数据分层的好处：

- 清晰数据结构：让每个数据层都有自己的作用和职责，在使用和维护的时候能够更方便和理解
- 复杂问题简化：将一个复杂的任务拆解成多个步骤来分步骤完成，每个层只解决特定的问题
- 统一数据口径：通过数据分层，提供统一的数据出口，统一输出口径
- 减少重复开发：规范数据分层，开发通用的中间层，可以极大地减少重复计算的工作

实时数仓和离线数仓都有ODS、DWD、DWS、ADS分层，或者有ODS、DWD、DWM、DWS、ADS。

### 1.ODS

数据准备区(Operation Data Store)。数据源中的数据，经过抽取、洗净、传输，也就是ETL过程之后进入本层。为了考虑后续可能需要追溯数据问题，因此对于这一层就不建议做过多的数据清洗工作，原封不动地接入原始数据即可。

该层的主要功能：

- ODS是后面数据仓库层的准备区
- 为DWD层提供原始数据
- 减少对业务系统的影响
- 数据备份

这层的数据是后续数据仓库加工数据的来源。数据来源的方式：

- 业务库：sqoop/DataX定时抽取数据；实时方面考虑使用Canal监听mysql的binlog日志，实时接入即可
- 埋点日志：日志一般是以文件的形式保存，可以选择使用flume来定时同步；可以使用spark streaming或者Flink、Kafka来实时接入
- 消息队列：来自ActiveMQ、Kafka的数据等

### 2.DWD

数据细节层(Data Warehouse Details)。该层是业务层和数据仓库的隔离层，保持和ODS层一样的数据颗粒度；主要是对ODS数据层做一些数据的清洗和规范化的操作，比如去除空数据、脏数据、离群值等。为了提高数据明细层的易用性，该层通常会才采用一些维度退化方法，将维度退化至事实表中，减少事实表和维表的关联。

### 3.DWM

数据中间层(Data Warehouse Middle)。该层是在DWD层的数据基础上，对数据做一些轻微的聚合操作，生成一些列的中间结果表，提升公共指标的复用性，减少重复加工的工作。简答来说，对通用的核心维度进行聚合操作，算出相应的统计指标。

### 4.DWS

数据服务层(Data Warehouse Service)。该层是基于DWM上的基础数据，整合汇总成分析某一个主题域的数据服务层，一般是宽表，用于提供后续的业务查询，OLAP分析，数据分发等。一般来说，该层的数据表会相对较少；一张表会涵盖比较多的业务内容，由于其字段较多，因此一般也会称该层的表为宽表。

### 5.ADS

数据应用层(Application Data Service)。该层主要是提供给数据产品和数据分析使用的数据，一般会存放在ES、Redis、PostgreSql等系统中供线上系统使用；也可能存放在hive或者Druid中，供数据分析和数据挖掘使用，比如常用的数据报表就是存在这里的。

## 三、项目需求以及架构分析

### 1.离线数仓的需求

| 主题       | 子主题             | 指标                         |
| ---------- | ------------------ | ---------------------------- |
| 流量主题   | 各渠道流量统计     | 当日各渠道独立访客数         |
| 流量主题   | 各渠道流量统计     | 当日各渠道会话总数           |
| 流量主题   | 各渠道流量统计     | 当日各渠道会话平均浏览页面数 |
| 流量主题   | 各渠道流量统计     | 当日各渠道会话平均停留时长   |
| 流量主题   | 各渠道流量统计     | 当日各渠道跳出率             |
| 流量主题   | 路径分析           | 路径分析                     |
| 用户主题   | 用户变动统计       | 流失用户数                   |
| 用户主题   | 用户变动统计       | 回流用户数                   |
| 用户主题   | 用户留存统计       | 新增留存率                   |
| 用户主题   | 用户新增活跃统计   | 新增用户数                   |
| 用户主题   | 用户新增活跃统计   | 活跃用户数                   |
| 用户主题   | 用户行为漏斗分析   | 首页浏览人数                 |
| 用户主题   | 用户行为漏斗分析   | 商品详情页浏览人数           |
| 用户主题   | 用户行为漏斗分析   | 加购人数                     |
| 用户主题   | 用户行为漏斗分析   | 下单人数                     |
| 用户主题   | 用户行为漏斗分析   | 支付人数                     |
| 用户主题   | 新增下单用户统计   | 新增下单人数                 |
| 用户主题   | 新增下单用户统计   | 新增支付成功人数             |
| 用户主题   | 新增下单用户统计   | 最近7日内连续3日下单用户数   |
| 商品主题   | 复购率统计         | 最近30日各品牌复购率         |
| 商品主题   | 各品牌商品下单统计 | 各品牌订单数                 |
| 商品主题   | 各品牌商品下单统计 | 各品牌订单人数               |
| 商品主题   | 各品类商品交易统计 | 各品类订单数                 |
| 商品主题   | 各品类商品交易统计 | 各品类订单人数               |
| 商品主题   | 购物车存量统计     | 各分类商品购物车存量Top3     |
| 商品主题   | 购物车存量统计     | 各品牌商品收藏次数Top3       |
| 商品交易   | 下单时间统计       | 下单到支付时间间隔平均值     |
| 商品交易   | 各省份交易统计     | 各省份订单数                 |
| 商品交易   | 各省份交易统计     | 各省份订单金额               |
| 优惠券主题 | 优惠券使用率统计   | 使用次数                     |
| 优惠券主题 | 优惠券使用率统计   | 使用人数                     |

### 2.实时数仓的需求

| 主题       | 子主题             | 指标                           |
| ---------- | ------------------ | ------------------------------ |
| 流量主题   | 各渠道流量统计     | 当日各渠道独立访客数           |
| 流量主题   | 各渠道流量统计     | 当日各渠道会话总数             |
| 流量主题   | 各渠道流量统计     | 当日各渠道会话平均浏览页面数   |
| 流量主题   | 各渠道流量统计     | 当日各渠道会话平均停留时长     |
| 流量主题   | 各渠道流量统计     | 当日各渠道跳出率               |
| 流量主题   | 流量分时统计       | 当日各小时独立访客数           |
| 流量主题   | 流量分时统计       | 当日各小时页面浏览数           |
| 流量主题   | 流量分时统计       | 当日各小时新访客数             |
| 流量主题   | 新老客户流量统计   | 各类访客也面浏览数             |
| 流量主题   | 新老客户流量统计   | 各类访客平均在线时长           |
| 流量主题   | 新老客户流量统计   | 各类访客平均访问页面数         |
| 流量主题   | 关键词统计         | 当日各个关键词评分             |
| 用户主题   | 用户变动统计       | 当日各渠道会话平均停留时长     |
| 用户主题   | 用户新增活跃统计   | 当日回流用户数                 |
| 用户主题   | 用户新增活跃统计   | 当日新增用户数                 |
| 用户主题   | 用户行为漏斗分析   | 当日首页浏览人数               |
| 用户主题   | 用户行为漏斗分析   | 当日商品详情页浏览人数         |
| 用户主题   | 用户行为漏斗分析   | 当日加购人数                   |
| 用户主题   | 用户行为漏斗分析   | 当日下单人数                   |
| 用户主题   | 用户行为漏斗分析   | 当日成功支付人数               |
| 用户主题   | 新增交易用户统计   | 当日新增下单人数               |
| 用户主题   | 新增交易用户统计   | 当日新增成功支付人数           |
| 商品主题   | 复购率统计         | 最近7/30日截至当前各品牌复购率 |
| 商品主题   | 各品牌商品交易统计 | 当日各品牌订单数               |
| 商品主题   | 各品牌商品交易统计 | 当日各品牌订单人数             |
| 商品主题   | 各品牌商品交易统计 | 当日各品牌订单金额             |
| 商品主题   | 各品牌商品交易统计 | 当日各品牌退单数               |
| 商品主题   | 各品牌商品交易统计 | 当日各品牌退单人数             |
| 商品主题   | 各品类商品交易统计 | 当日各品类订单数               |
| 商品主题   | 各品类商品交易统计 | 当日各品类订单人数             |
| 商品主题   | 各品类商品交易统计 | 当日各品类订单金额             |
| 商品主题   | 各品类商品交易统计 | 当日各品类退单数               |
| 商品主题   | 各品类商品交易统计 | 当日各品类退单人数             |
| 商品主题   | 各SPU商品交易统计  | 当日各SPU订单数                |
| 商品主题   | 各SPU商品交易统计  | 当日各SPU订单人数              |
| 商品主题   | 各SPU商品交易统计  | 当日各SPU订单金额              |
| 交易主题   | 交易综合统计       | 当日订单金额                   |
| 交易主题   | 交易综合统计       | 当日订单数                     |
| 交易主题   | 交易综合统计       | 当日订单人数                   |
| 交易主题   | 交易综合统计       | 当日退单数                     |
| 交易主题   | 交易综合统计       | 当日退单人数                   |
| 交易主题   | 交易综合统计       | 当日各省订单数                 |
| 交易主题   | 交易综合统计       | 当日各省订单金额               |
| 优惠券主题 | 优惠券使用率统计   | 当日优惠券补贴率               |
| 活动主题   | 活动补贴率统计     | 当日活动补贴率                 |

### 3.采集平台

用户行为数据采集平台搭建

业务数据采集平台搭建

### 4.技术选型

考虑因素：数据量大小、业务需求、技术成熟度、开发维护成本、总成本预算。

数据采集传输：离线和实时共用的（Flume、Kafka、Maxwell）、离线（DataX）

数据存储：离线和实时共用的(MySQL)、离线(HDFS)、实时(HBase、Redis)

数据计算：离线(Hive、Spark)、实时(Flink)

数据查询：离线(Presto)、实时(ClickHouse)

数据可视化：离线(Superset)、实时(Sugar)

任务调度：离线(DolphinScheduler)

集群监控：离线(Zabbix)、实时(Prometheus)

元数据管理：Atlas

权限管理：Ranger、Sentry

### 5.数据流转

![data_flow](..\picture\data_flow.png)

### 6.各组件版本选择

![组件版本](..\picture\zujian.png)

## 四、用户行为日志

### 1.用户行为日志概述

用户行为日志的内容，主要包括用户的各项**行为信息**以及行为所处的**环境信息**。收集这些信息的主要目的是优化产品和为各项分析统计指标提供数据支撑。收集这些信息的手段通常为**埋点**。

目前主流的埋点方式，有代码埋点（前端/后端）、可视化埋点、全埋点等。

**代码埋点**是通过调用埋点SDK函数，在需要埋点的业务逻辑功能位置调用接口，上报埋点数据。例如，我们对页面中的某个按钮埋点后，当这个按钮被点击时，可以在这个按钮对应的 OnClick 函数里面调用SDK提供的数据发送接口，来发送数据。

**可视化埋点**只需要研发人员集成采集 SDK，不需要写埋点代码，业务人员就可以通过访问分析平台的“圈选”功能，来“圈”出需要对用户行为进行捕捉的控件，并对该事件进行命名。圈选完毕后，这些配置会同步到各个用户的终端上，由采集 SDK 按照圈选的配置自动进行用户行为数据的采集和发送。

**全埋点**是通过在产品中嵌入SDK，前端自动采集页面上的全部用户行为事件，上报埋点数据，相当于做了一个统一的埋点。然后再通过界面配置哪些数据需要在系统里面进行分析。

### 2.日志内容

本项目收集和分析的用户行为信息主要有**页面浏览记录、动作记录、曝光记录、启动记录和错误记录。**

#### 2.1页面浏览记录

页面浏览记录，记录的是访客对页面的浏览行为，该行为的环境信息主要有用户信息、时间信息、地理位置信息、设备信息、应用信息、渠道信息及页面信息等。

#### 2.2动作记录

动作记录，记录的是用户的业务操作行为，该行为的环境信息主要有用户信息、时间信息、地理位置信息、设备信息、应用信息、渠道信息 及动作目标对象信息等。

#### 2.3曝光记录

曝光记录，记录的是曝光行为，该行为的环境信息主要有用户信息、时间信息、地理位置信息、设备信息、应用信息、渠道信息及曝光对象信息等。

#### 2.4启动记录

启动记录，记录的是用户启动应用的行为，该行为的环境信息主要有用户信息、时间信息、地理位置信息、设备信息、应用信息、渠道信息、启动类型及开屏广告信息等。

#### 2.5错误记录

启动记录，记录的是用户在使用应用过程中的报错行为，该行为的环境信息主要有用户信息、时间信息、地理位置信息、设备信息、应用信息、渠道信息、以及可能与报错相关的页面信息、动作信息、曝光信息和动作信息。